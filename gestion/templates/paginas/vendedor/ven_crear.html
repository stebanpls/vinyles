{% extends "plantillas/plantilla_vendedor.html" %}
{% load static %}
{% load widget_tweaks %}

{% block extra_css %}
    <!-- <link rel="stylesheet" href="{% static 'css/paginas/vendedor/style_crear.css' %}"> -->
      <style>
    .select2-container--default .select2-results__option {
      color: #000 !important;
      background-color: #fff !important;
    }

    .select2-container--default .select2-results__option--highlighted[aria-selected] {
      background-color: #0d6efd !important;
      color: white !important;
    }

    .modal {
      overflow-y: auto !important;
    }

    .select2-container--open {
      z-index: 9999 !important;
    }

    .select2-dropdown {
      z-index: 9999 !important;
    }
  </style>
{% endblock extra_css %}

{% block titulo %}Vinyles - √Ålbumes{% endblock titulo %}

{% block contenido %}
<form method="post" enctype="multipart/form-data" class="p-4 border rounded bg-light">
{% csrf_token %}

    <div class="mb-3">
        <label for="id_titulo" class="form-label " style="color: black;">T√≠tulo del √Ålbum</label>
        {{ producto_form.titulo }}
    </div>

    <div class="mb-3">
        <label for="id_fecha_lanzamiento" class="form-label" style="color: black;">Fecha de Lanzamiento</label>
        {{ producto_form.fecha_lanzamiento }}
    </div>

    <div class="mb-3">
        <label for="id_precio" class="form-label " style="color: black;">Precio</label>
        {{ producto_form.precio|add_class:"form-control" }}
    </div>

    <div class="mb-3">
        <label for="id_stock" class="form-label " style="color: black;">Stock disponible</label>
        {{ producto_form.stock|add_class:"form-control" }}
    </div>

    <div class="mb-3">
        <label for="id_sello_discografico" class="form-label " style="color: black;" >Sello Discogr√°fico</label>
        {{ producto_form.sello_discografico|add_class:"form-control" }}
    </div>

    <div class="mb-3">
        <label for="id_imagen_portada" class="form-label " style="color: black;">Imagen de Portada</label>
        {{ producto_form.imagen_portada|add_class:"form-control" }}
    </div>

    <div class="mb-3">
        <label for="id_genero_principal" class="form-label " style="color: black;">G√©nero(s) Principal(es)</label>
        {{ producto_form.genero_principal|add_class:"form-control select-genero"  }}
    </div>

        <div class="input-group">
          <button type="button" class="btn btn-outline-primary" onclick="abrirModalGenero('{% url 'modal_genero_crear' %}')">
            + Agregar nuevo g√©nero
          </button>
        </div>

<br>

    <div class="mb-3">
        <label for="id_artistas" class="form-label " style="color: black;">Seleccionar Artista(s)</label>
        {{ producto_form.artistas|add_class:"form-control select-artista"  }}
    </div>

    <div class="input-group">
      <button type="button" class="btn btn-outline-primary" onclick="abrirModalArtista('{% url 'modal_artista_crear' %}')">
        + Agregar nuevo artista
      </button>
    </div>

<br>

    <div id="contenedor-canciones">
      <div class="cancion-row d-flex align-items-center mb-2">
        <select name="cancion_0" class="form-control select-cancion me-2" required>
          <option value="">Selecciona una canci√≥n</option>
            {% for cancion in canciones %}
          <option value="{{ cancion.id }}">{{ cancion.nombre }}</option>
            {% endfor %}
        </select>
      <input type="number" name="pista_0" class="form-control me-2" value="1" readonly style="max-width: 100px;">
    <button type="button" class="btn btn-danger btn-sm eliminar-cancion">X</button>
  </div>
</div>



<div>
<button type="button" class="btn btn-secondary mt-2" onclick="agregarCancion()">+ Agregar otra canci√≥n</button>
</div>
<br>
<div>
    <button type="button" class="btn btn-outline-primary " onclick="abrirModalCancion('{% url 'modal_cancion_crear' %}')">
    + Agregar nueva Cancion
</button>
</div>

    <div class="mb-3">
        <label for="id_descripcion" class="form-label " style="color: black;" style="color: black;">Descripci√≥n del estado del producto </label>
        {{ producto_form.descripcion|add_class:"form-control" }}
    </div>




    <br><br>
    <button type="button" class="btn btn-primary btn-confirmar">Crear Porducto</button>
</form>

<!-- Modal vac√≠o, se llenar√° v√≠a fetch -->
<div class="modal fade" id="modalFormulario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="modalContent">
      <!-- Aqu√≠ se carga el HTML del formulario -->
    </div>
  </div>
</div>
<!-- Modal para Canci√≥n -->
<div class="modal fade" id="modalCancion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="modalContentCancion"></div>
  </div>
</div>

<!-- Modal para Artista -->
<div class="modal fade" id="modalArtista" tabindex="-1" aria-labelledby="modalArtistaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="modalContentArtista"></div>
  </div>
</div>


<!-- Modal de G√©nero -->
<div class="modal fade" id="modalGenero" tabindex="-1" aria-labelledby="modalGeneroLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="modalContentGenero">
      <!-- Aqu√≠ se inyecta el contenido del formulario -->
    </div>
  </div>
</div>

<!-- ‚úÖ Modal para Productor -->
<div class="modal fade" id="modalProductor" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="modalContentProductor"></div>
  </div>
</div>

<div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-labelledby="modalConfirmacionLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="modalConfirmacionLabel">¬øGuardar cambios?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¬øEst√°s segur@ de que quieres guardar estos cambios?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmarGuardar">S√≠, guardar</button>
      </div>
    </div>
  </div>
</div>



{% endblock contenido %}

{% block pie %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<script>
//JS PARA EL FOMULARIO DE CREAR ALBUM 
//esto es para que funcione lo de agregar canciones y el boton de eliminar
  const cancionesDisponibles = [
    {% for cancion in canciones %}
      { id: {{ cancion.id }}, nombre: "{{ cancion.nombre }}" },
    {% endfor %}
  ];



  //para que funcione el select 2 
$(document).ready(function () {
  // Inicializar Select2 para el campo de artistas del formulario principal (√°lbum)
  // Usamos el ID espec√≠fico para mayor robustez.
  // Asumimos que el campo en ProductoForm se llama 'artistas', por lo que su ID es 'id_artistas'.
  if ($('#id_artistas').length && !$('#id_artistas').data('select2')) {
    $('#id_artistas').select2({
      placeholder: "Busca y selecciona artista(s) del √°lbum",
      width: '100%'
    });
  }

  $('.select-genero').select2({
    placeholder: "Selecciona g√©nero(s)",
    width: '100%'
  });

  $('.select-productor').select2({
    placeholder: "Busca y selecciona productor(es)",
    width: '100%'
  });

  console.log("‚úÖ Select2 cargado para artista, g√©nero y productor");

  // Inicializa botones de eliminar (si los tienes din√°micamente generados)
  actualizarBotonesEliminar();
});


//abre el modal de artista
// Abre el modal de artista

function abrirModalArtista(url, desdeCancion = false) {
  fetch(url)
    .then(response => response.text())
    .then(html => {
      document.getElementById("modalContentArtista").innerHTML = html;
      let modal = new bootstrap.Modal(document.getElementById('modalArtista'));
      modal.show();

      const form = document.querySelector("#modalArtista form");

      if (desdeCancion) {
        form.addEventListener("submit", function (event) {
          event.preventDefault();
          enviarFormularioArtistaDesdeCancion(event, form);
        });
      } else {
        form.addEventListener("submit", function (event) {
          event.preventDefault();
          enviarFormularioArtista(event, form, "id_artistas", "modalArtista");
        });
      }

      const modalContent = $('#modalArtista .modal-content');
      $('#modalArtista .select-artista').select2({
        placeholder: "Selecciona artista(s)",
        dropdownParent: modalContent,
        width: '100%'
      });
    });
}


function enviarFormularioArtista(event, form, idSelect = "id_artistas", modalId = "modalArtista") {
  event.preventDefault();
  const url = form.action;
  const formData = new FormData(form);

  fetch(url, {
    method: 'POST',
    body: formData,
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const select = document.getElementById(idSelect);
      const option = new Option(data.nombre, data.id, true, true);
      select.appendChild(option);
      $('#' + idSelect).trigger('change');

      const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
      modal.hide();
      alert("‚úÖ Artista creado con √©xito");
    } else {
      // 1. Guardar los valores escritos por el usuario antes de reemplazar el HTML
      const valoresActuales = {};
      form.querySelectorAll("input, textarea, select").forEach(input => {
        if (input.name) {
          valoresActuales[input.name] = input.value;
        }
      });

      // 2. Reemplazar el contenido del modal con el nuevo HTML que incluye errores
      document.getElementById("modalContentArtista").innerHTML = data.form_html;

      // 3. Volver a colocar los valores escritos por el usuario en el nuevo formulario
      const nuevoForm = document.querySelector(#${modalId} form);
      Object.keys(valoresActuales).forEach(name => {
        const campo = nuevoForm.querySelector([name="${name}"]);
        if (campo) {
          campo.value = valoresActuales[name];
        }
      });

      // 4. Volver a enganchar el evento submit para que siga funcionando
      nuevoForm.addEventListener("submit", function (event) {
        enviarFormularioArtista(event, nuevoForm, idSelect, modalId);
      });
    }
  });
}


function enviarFormularioArtistaDesdeCancion(event, form) {
  event.preventDefault();
  const url = form.action;
  const formData = new FormData(form);

  fetch(url, {
    method: 'POST',
    body: formData,
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Referencia al select de artista dentro del modal de canci√≥n
      const selectArtista = document.querySelector('#modalCancion .select-artista');
      
      // Crear opci√≥n y agregarla al select
      const nuevaOpcion = new Option(data.nombre, data.id, true, true);
      selectArtista.appendChild(nuevaOpcion);

      // Actualizar select2
      $(selectArtista).trigger('change');

      // Cerrar solo el modal de artista
      const modal = bootstrap.Modal.getInstance(document.getElementById("modalArtista"));
      modal.hide();

      alert("‚úÖ Artista creado con √©xito");
    } else {
      // Si hay errores, recargar el form con los errores visibles
      document.getElementById("modalContentArtista").innerHTML = data.form_html;

      const nuevoForm = document.querySelector("#modalArtista form");
      nuevoForm.addEventListener("submit", function (event) {
        enviarFormularioArtistaDesdeCancion(event, nuevoForm);
      });
    }
  });
}


//abrir el modal genero 
function abrirModalGenero(url) {
  fetch(url)
    .then(response => response.text())
    .then(html => {
      document.getElementById("modalContentGenero").innerHTML = html;
      let modal = new bootstrap.Modal(document.getElementById('modalGenero'));
      modal.show();

      const form = document.querySelector("#modalGenero form");
      form.addEventListener("submit", function (event) {
        event.preventDefault();
        enviarFormularioGenero(event, form, "id_generos", "modalGenero");  // usa el ID real del select en el formulario
      });
    });
}

//enviar el fromualrio de genero 
function enviarFormularioGenero(event, form, idSelect = "id_genero_principal", modalId = "modalFormulario") {
  event.preventDefault();
  const url = form.action;
  const formData = new FormData(form);

  fetch(url, {
    method: 'POST',
    body: formData,
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const select = document.getElementById(idSelect);
      const option = new Option(data.nombre, data.id, true, true);
      select.appendChild(option);
      $('#' + idSelect).trigger('change');

      const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
      modal.hide();
      alert("‚úÖ G√©nero creado con √©xito");
    } else {
      const contentId = modalId === "modalFormulario" ? "modalContent" : "modalContentGenero";
      document.getElementById(contentId).innerHTML = data.form_html;

      // üí• Volvemos a enganchar el submit al nuevo form renderizado
      const nuevoForm = document.querySelector(#${modalId} form);
      nuevoForm.addEventListener("submit", function (event) {
        enviarFormularioGenero(event, nuevoForm, idSelect, modalId);
      });
    }
  });
}



//abre el modal de cancion desde el formulario de album 
function abrirModalCancion(url) {
  fetch(url)
    .then(response => response.text())
    .then(html => {
      document.getElementById("modalContentCancion").innerHTML = html;

      const modalCancion = new bootstrap.Modal(document.getElementById('modalCancion'));
      modalCancion.show();

      const modalContent = $('#modalCancion .modal-content');

      // Inicializar Select2 dentro del modal
      // Inicializar Select2 para artista sin romper estilos previos
$('#modalCancion select.select-artista').each(function () {
  if (!$(this).hasClass('select2-hidden-accessible')) {
    $(this).select2({
      placeholder: "Busca y selecciona artista(s)",
      dropdownParent: modalContent,
      width: '100%'
    });
  }
});


      $('#modalCancion .select-productor').select2({
        placeholder: "Busca y selecciona productor(es)",
        dropdownParent: modalContent,
        width: '100%'
      });

      $('#modalCancion .select-genero').select2({
        placeholder: "Selecciona g√©nero(s)",
        dropdownParent: modalContent,
        width: '100%'
      });

      // üîÅ Conectar formulario al submit
      const form = document.querySelector("#modalCancion form");
form.addEventListener("submit", function (event) {
  enviarFormularioCancion(event, form);
});


      console.log("üéµ Modal de canci√≥n abierto y Select2 listo.");
    });
}


//envia el formulario con la cancion creada y se autoselecciona 
function enviarFormularioCancion(event, form) {
  event.preventDefault();
  const url = form.action;
  const formData = new FormData(form);

  fetch(url, {
    method: 'POST',
    body: formData,
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Cerrar el modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalCancion'));
        modal.hide();

        // Agregar la nueva canci√≥n al formulario del √°lbum
        const contenedor = document.getElementById("contenedor-canciones");

        const cantidadActual = contenedor.querySelectorAll('.cancion-row').length;
        const nuevaCancionHTML = `
          <div class="cancion-row d-flex align-items-center mb-2">
            <select name="cancion_${cantidadActual}" class="form-control select-cancion me-2" required>
              <option value="${data.id}" selected>${data.nombre}</option>
            </select>
            <input type="number" name="pista_${cantidadActual}" class="form-control me-2" value="${cantidadActual + 1}" readonly style="max-width: 100px;">
            <button type="button" class="btn btn-danger btn-sm eliminar-cancion">X</button>
          </div>
        `;
        contenedor.insertAdjacentHTML('beforeend', nuevaCancionHTML);

        alert("‚úÖ Canci√≥n creada y a√±adida correctamente.");
      } else {
        // Reemplazar contenido del modal con el formulario con errores
        document.getElementById("modalContentCancion").innerHTML = data.form_html;
      }
    });
}


//TODO ESTO ES PARA QUE FUNCIONE ELIMINAR AGREGAR CANCIONES Y SE ACTUALIZA LA PISTA DE ESTA 
function agregarCancion() {
  const contenedor = document.getElementById("contenedor-canciones");
  const cantidadActual = contenedor.querySelectorAll(".cancion-row").length;

  const nuevaCancionHTML = `
    <div class="cancion-row d-flex align-items-center mb-2">
      <select name="cancion_${cantidadActual}" class="form-control select-cancion me-2" required>
        <option value="">Selecciona una canci√≥n</option>
        ${cancionesDisponibles.map(c => <option value="${c.id}">${c.nombre}</option>).join('')}
      </select>
      <input type="number" name="pista_${cantidadActual}" class="form-control me-2" value="${cantidadActual + 1}" readonly style="max-width: 100px;">
      <button type="button" class="btn btn-danger btn-sm eliminar-cancion">X</button>
    </div>
  `;

  contenedor.insertAdjacentHTML("beforeend", nuevaCancionHTML);
  actualizarBotonesEliminar(); // Volver a enlazar los botones
}

function actualizarBotonesEliminar() {
  document.querySelectorAll(".eliminar-cancion").forEach(btn => {
    btn.removeEventListener("click", eliminarCancion);
    btn.addEventListener("click", eliminarCancion);
  });
}

function eliminarCancion(event) {
  const fila = event.target.closest(".cancion-row");
  fila.remove();
  renumerarPistas();
}

function renumerarPistas() {
  const filas = document.querySelectorAll("#contenedor-canciones .cancion-row");
  filas.forEach((fila, index) => {
    const pistaInput = fila.querySelector("input[name^='pista_']");
    const select = fila.querySelector("select[name^='cancion_']");

    pistaInput.value = index + 1;
    pistaInput.name = pista_${index};
    select.name = cancion_${index};
  });
}





//ABRIR MODALS DESDE CANCION 
//abre el modal de productor
function abrirModalProductorDesdeCancion(url) {
  fetch(url)
    .then(response => response.text())
    .then(html => {
      document.getElementById("modalContentProductor").innerHTML = html;

      const modal = new bootstrap.Modal(document.getElementById("modalProductor"));
      modal.show();

      const modalContent = $('#modalProductor .modal-content');

      $('#modalProductor select').select2({
        dropdownParent: modalContent,
        width: '100%'
      });

      // Conectar el formulario del modal
      const form = document.querySelector("#modalProductor form");
      form.addEventListener("submit", function (event) {
        enviarFormularioProductor(event, form);
      });

      console.log("üé¨ Modal de Productor abierto desde Canci√≥n.");
    });
}


//envia el formulario con el productor creado y se autoselecciona
function enviarFormularioProductor(event, form) {
  event.preventDefault();

  const url = form.action;
  const formData = new FormData(form);

  fetch(url, {
    method: 'POST',
    body: formData,
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalProductor"));
        modal.hide();

        const nuevoOption = new Option(data.nombre, data.id, true, true);
        $('#modalCancion .select-productor-modal').append(nuevoOption).trigger('change');

        alert("‚úÖ Productor creado y a√±adido a la canci√≥n.");
      } else {
        document.getElementById("modalContentProductor").innerHTML = data.form_html;
      }
    });
}



//abrir el modal de genero 
function abrirModalGenero(url, desdeCancion = false) {
  fetch(url)
    .then(response => response.text())
    .then(html => {
      document.getElementById("modalContentGenero").innerHTML = html;
      let modal = new bootstrap.Modal(document.getElementById('modalGenero'));
      modal.show();

      const form = document.querySelector("#modalGenero form");

      if (desdeCancion) {
        form.addEventListener("submit", function (event) {
          event.preventDefault();
          enviarFormularioGeneroDesdeCancion(event, form);
        });
      } else {
        form.addEventListener("submit", function (event) {
          event.preventDefault();
          enviarFormularioGenero(event, form, "id_genero_principal", "modalGenero");
        });
      }
    });
}


//enviar el formulario de genero 
function enviarFormularioGeneroDesdeCancion(event, form) {
  event.preventDefault();
  const url = form.action;
  const formData = new FormData(form);

  fetch(url, {
    method: 'POST',
    body: formData,
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Cerrar el modal de g√©nero
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalGenero'));
        modal.hide();

        // Agregar nuevo g√©nero al select dentro del modal de canci√≥n
        const nuevoOption = new Option(data.nombre, data.id, true, true);
        $('#modalCancion .select-genero').append(nuevoOption).trigger('change');

        alert("‚úÖ G√©nero creado y a√±adido al formulario de canci√≥n.");
      } else {
        // Re-renderizar el formulario con errores
        document.getElementById("modalContentGenero").innerHTML = data.form_html;

        // Volver a enlazar el formulario con el submit personalizado
        const nuevoForm = document.querySelector("#modalGenero form");
        nuevoForm.addEventListener("submit", function (e) {
          e.preventDefault();
          enviarFormularioGeneroDesdeCancion(e, nuevoForm);
        });

        // Volver a inicializar los Select2 dentro del modal
        const modalContent = $('#modalGenero .modal-content');

        $('#modalGenero .select-artista').select2({
          placeholder: "Busca y selecciona artista(s)",
          dropdownParent: modalContent,
          width: '100%'
        });

        $('#modalGenero .select-productor').select2({
          placeholder: "Busca y selecciona productor(es)",
          dropdownParent: modalContent,
          width: '100%'
        });

        $('#modalGenero .select-genero').select2({
          placeholder: "Selecciona g√©nero(s)",
          dropdownParent: modalContent,
          width: '100%'
        });
      }
    });
}


document.addEventListener('DOMContentLoaded', function () {
  let formularioTemporal = null;
  const modalConfirmacion = new bootstrap.Modal(document.getElementById('modalConfirmacion'));

  document.querySelectorAll('.btn-confirmar').forEach(boton => {
    boton.addEventListener('click', function () {
      const form = boton.closest('form');
      if (!form) return;

      if (form.checkValidity()) {
        formularioTemporal = form;
        modalConfirmacion.show();
      } else {
        form.reportValidity(); // Muestra errores nativos del navegador
      }
    });
  });

  document.getElementById('confirmarGuardar').addEventListener('click', function () {
  if (formularioTemporal) {
    // Disparamos el evento submit como si el usuario lo hubiera hecho
    const evento = new Event('submit', { bubbles: true, cancelable: true });
    formularioTemporal.dispatchEvent(evento);
    modalConfirmacion.hide();
    formularioTemporal = null;
  }
});

});


//enviar el formulario de artista 


</script>

{% endblock pie %}