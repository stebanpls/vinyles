{% extends "plantillas/plantilla_vendedor.html" %}
{% load static %}
{% load widget_tweaks %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-5-theme/1.3.0/select2-bootstrap-5-theme.min.css" />
    <style>
        .select2-container--bootstrap-5 .select2-dropdown {
            background-color: #343a40;
            border-color: #6c757d;
        }
        .select2-container--bootstrap-5 .select2-results__option {
            color: #f8f9fa;
        }
        .select2-container--bootstrap-5 .select2-results__option--highlighted {
            background-color: #0d6efd;
        }
        .select2-container--bootstrap-5 .select2-search__field {
            background-color: #495057;
            color: #f8f9fa;
            border-color: #6c757d;
        }
    </style>

{% endblock %}

{% block titulo %}Vender un Vinilo{% endblock %}

{% block contenido %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1 class="text-center mb-4">Vender un Vinilo</h1>
            <p class="text-center text-muted">
                Busca un artista y selecciona el álbum que deseas vender. Si no está en nuestro catálogo, lo importaremos desde Discogs por ti.
            </p>

            <!-- Contenedor de Búsqueda -->
            <div id="search-container" class="p-4 border rounded bg-light text-dark shadow-sm mb-4">
                <div class="mb-4">
                    <label for="id_artista_search" class="form-label fw-bold">Paso 1: Busca el Artista</label>
                    <select id="id_artista_search" class="form-select form-select-lg"></select>
                </div>
                <div class="mb-4">
                    <label for="id_album_search" class="form-label fw-bold">Paso 2: Selecciona el Álbum</label>
                    <select id="id_album_search" class="form-select form-select-lg" disabled></select>
                </div>
            </div>

            <h3 class="mt-4 mb-3">Paso 3: Describe tu Copia</h3>
                <form method="post" id="sale-form" class="p-4 border rounded bg-light text-dark shadow-sm">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">Poner en Venta</button>
                        <button type="button" id="cancel-sale-btn" class="btn btn-secondary">Cancelar y buscar de nuevo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock contenido %}

{% block pie %}
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/es.js"></script>

    <script>
    $(document).ready(function() {
        $('#id_artista').select2({
            theme: "bootstrap-5",
            language: "es", // Usar el idioma español
            ajax: {
                url: $('#id_artista').data('ajax-url'), // URL desde el atributo data-*
                dataType: 'json',
                delay: 250, // Esperar 250ms después de que el usuario deje de escribir
                data: function (params) {
                    return {
                        term: params.term // Término de búsqueda
                    };
                },
                processResults: function (data) {
                    // Transforma la respuesta JSON al formato que Select2 espera
                    return {
                        results: data.results
                    };
                },
                cache: true
            },
            placeholder: 'Escribe para buscar un artista...',
            minimumInputLength: 2 // Empezar a buscar después de 2 caracteres
        });

        $('#id_album').select2({
            theme: "bootstrap-5",
            language: "es",
            placeholder: "Selecciona un artista primero",
        });

        $('#id_artista').on('change', function() {
            const artistaId = $(this).val();
            const albumSelect = $('#id_album');

            if (artistaId) {
                $.ajax({
                    url: "{% url 'ajax_cargar_albumes' %}", // Esta URL sigue siendo correcta para cargar álbumes
                    data: { 'artista_id': artistaId },
                    success: function(data) {
                        albumSelect.empty().append('<option value="">-- Elige un álbum --</option>');
                        $.each(data, function(key, value) {
                            albumSelect.append($('<option>', {
                                value: value.id,
                                text: value.nombre
                            }));
                        });
                        albumSelect.prop('disabled', false);
                        $('#id_precio, #id_stock, #id_descripcion_condicion').prop('disabled', false);
                    }
                });
            } else {
                albumSelect.empty().append('<option value="">Selecciona un artista primero</option>').prop('disabled', true);
            }
        });
    });
    </script>
{% endblock pie %}
