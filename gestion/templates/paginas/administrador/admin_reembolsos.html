{% extends "plantillas/plantilla_administrador.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/paginas/administrador/style_pedido_pendiente.css' %}">
{% endblock extra_css %}

{% block titulo %} Vinyles - Reembolsos {% endblock titulo %}

{% block contenido %}
<section class="seccion-pedidos">
  <div class="textos">
    <h1 class="bienvenida">Reembolsos</h1>
    <p class="bien">Aquí gestionas los reembolsos pendientes. Aprueba o rechaza según el caso.</p>
  </div>

  <input type="text" id="buscador" placeholder="Buscar cliente..." class="busqueda">

  <div class="acordeon" id="lista-reembolsos">
    {% for reembolso in reembolsos %}
    <div class="acordeon-item" data-id="{{ reembolso.id }}">
      <button class="acordeon-btn" onclick="togglePedido(this)">
        <i class="fas fa-user"></i>
        {{ reembolso.usuario.get_full_name|default:reembolso.usuario.username }}
        <i class="fas fa-chevron-down flecha"></i>
      </button>

      <div class="acordeon-panel">
        <div class="producto">
          <a href="{% url 'admin_adPro' reembolso.producto.id %}">
            <img src="{{ reembolso.producto.imagen_portada.url }}" alt="{{ reembolso.producto.nombre }}">
            <p class="nombre-producto">{{ reembolso.producto.nombre }}</p>
          </a>
        </div>

        <div class="info-pedido">
          <p><strong>Correo:</strong> {{ reembolso.usuario.email }}</p>
          <p><strong>Número de pedido:</strong> #{{ reembolso.pedido.id }}</p>
          <p><strong>Motivo:</strong> {{ reembolso.motivo }}</p>
          <p><strong>Fecha:</strong> {{ reembolso.fecha_solicitud|date:"Y-m-d H:i" }}</p>
        </div>

        <div class="acciones">
          <button class="btn-confirmar" onclick="gestionarReembolso(this, 'autorizado')">Autorizar</button>
          <button class="btn-cancelar" onclick="gestionarReembolso(this, 'rechazado')">Rechazar</button>
          <div class="mensaje"></div>
        </div>
      </div>
    </div>
    {% empty %}
    <p style="text-align:center; color:#ccc; margin-top: 2rem;">
      <i class="fas fa-money-check-alt" style="font-size: 1.5rem;"></i><br>
      No hay solicitudes de reembolso por ahora.
    </p>
    {% endfor %}
  </div>
</section>
{% endblock contenido %}

{% block pie %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function togglePedido(boton) {
  boton.classList.toggle("activo");
  const panel = boton.nextElementSibling;
  panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
}

function gestionarReembolso(btn, estado) {
  const item = btn.closest(".acordeon-item");
  const mensaje = item.querySelector(".mensaje");

  mensaje.textContent = estado === "autorizado"
    ? "Reembolso autorizado con éxito"
    : "Reembolso rechazado";
  mensaje.style.opacity = "1";

  setTimeout(() => {
    mensaje.style.opacity = "0";
  }, 2000);

  setTimeout(() => {
    item.style.opacity = "0";
    setTimeout(() => item.remove(), 300);
  }, 2500);
}

document.getElementById("buscador")?.addEventListener("keyup", () => {
  const texto = document.getElementById("buscador").value.toLowerCase();
  const items = document.querySelectorAll("#lista-reembolsos .acordeon-item");
  items.forEach(item => {
    const nombre = item.querySelector(".acordeon-btn")?.textContent.toLowerCase() || "";
    item.style.display = nombre.includes(texto) ? "block" : "none";
  });
});
</script>
{% endblock pie %}
