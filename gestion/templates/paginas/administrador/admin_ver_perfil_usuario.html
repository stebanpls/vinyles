{% extends "plantillas/plantilla_administrador.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/paginas/administrador/usuarios/style_ver_perfil_usuario.css' %}">
{% endblock extra_css %}

{% block titulo %} Administrador - Perfil de Usuario {% endblock titulo %}

{% block contenido %} 
<div class="perfil-container">
    <h2 class="titulo-perfil">Perfil {{ usuario.username }}</h2>

    <div class="perfil-card">
        <div class="perfil-avatar">
            {% if cliente.foto_perfil %}
                <img src="{{ cliente.foto_perfil.url }}" alt="Foto de perfil">
            {% else %}
                <img src="{% static 'images/default_profile.jpg' %}" alt="Avatar por defecto">
            {% endif %}
            <h3>{{ usuario.get_full_name|default:usuario.username }}</h3>
        </div>

        <div class="perfil-info">
            <p><strong>Correo electrónico:</strong> {{ usuario.email }}</p>
            <p><strong>Nombre de usuario:</strong> {{ usuario.username }}</p>
            <p><strong>Número de documento:</strong> {{ cliente.numero_documento|default:"No registrado" }}</p>
            <p><strong>Celular:</strong> {{ cliente.celular|default:"No registrado" }}</p>
            <p><strong>Dirección de residencia:</strong> {{ cliente.direccion_residencia|default:"No registrada" }}</p>
            <p><strong>Fecha de registro:</strong> {{ usuario.date_joined|date:"Y-m-d H:i" }}</p>
            <p><strong>Ultimo inicio de Sesión:</strong> {{ usuario.last_login|date:"Y-m-d H:i" }}</p>
        </div>
    </div>
</div>

<div class="bloq">
    <div class="acciones-usuario">
        <form method="POST" action="{% url 'admin_bloquear_usuario' usuario.id %}" onsubmit="return confirmarBloqueo('{{ usuario.get_full_name|default:usuario.username }}', {{ usuario.is_active|yesno:"true,false" }})">
            {% csrf_token %}
            {% if usuario.is_active %}
                <button type="submit" class="bloquear">Bloquear usuario </button>
            {% else %}
                <button type="submit" class="bloquear desbloquear">Desbloquear usuario </button>
            {% endif %}
        </form>

        <a href="{% url 'admin_user_edit' usuario.id %}" class="editar-btn">Editar perfil </a>

        <form method="POST" action="{% url 'admin_eliminar_usuario' usuario.id %}" onsubmit="return confirmarEliminacion('{{ usuario.get_full_name|default:usuario.username }}')">
            {% csrf_token %}
            <button type="submit" class="eliminar-btn">Eliminar usuario </button>
        </form>
    </div>
</div>
{% endblock contenido %}

{% block pie %}
<!-- Asegúrate de tener SweetAlert2 cargado -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function confirmarBloqueo(nombreUsuario, estaActivo) {
    return new Promise((resolve) => {
        Swal.fire({
            title: estaActivo ? '¿Bloquear usuario?' : '¿Desbloquear usuario?',
            text: estaActivo 
                ? `¿Estás segur@ de que quieres bloquear a ${nombreUsuario}? Esta acción evitará que pueda iniciar sesión.` 
                : `¿Deseas desbloquear a ${nombreUsuario}? Podrá volver a iniciar sesión.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: estaActivo ? 'Sí, bloquear' : 'Sí, desbloquear',
            cancelButtonText: 'Cancelar',
        }).then((result) => {
            resolve(result.isConfirmed);
        });
    });
}

function confirmarEliminacion(nombreUsuario) {
    return new Promise((resolve) => {
        Swal.fire({
            title: '¿Eliminar usuario?',
            text: `¿Estás segur@ de que quieres eliminar a ${nombreUsuario}? Esta acción es permanente.`,
            icon: 'error',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar',
        }).then((result) => {
            resolve(result.isConfirmed);
        });
    });
}

// ✅ Interceptar envío de formularios
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("form").forEach((form) => {
        const action = form.getAttribute("action");

        if (action.includes("bloquear_usuario")) {
            form.addEventListener("submit", async function (e) {
                e.preventDefault();
                const nombre = "{{ usuario.get_full_name|default:usuario.username }}";
                const activo = {{ usuario.is_active|yesno:"true,false" }};
                const confirmar = await confirmarBloqueo(nombre, activo);
                if (confirmar) form.submit();
            });
        }

        if (action.includes("eliminar_usuario")) {
            form.addEventListener("submit", async function (e) {
                e.preventDefault();
                const nombre = "{{ usuario.get_full_name|default:usuario.username }}";
                const confirmar = await confirmarEliminacion(nombre);
                if (confirmar) form.submit();
            });
        }
    });
});
</script>
{% endblock pie %}
